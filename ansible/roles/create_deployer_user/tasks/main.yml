---
- name: Ensure sudo package is installed
  package:
    name: sudo
    state: present

- name: Create deployer user
  user:
    name: "{{ deployer_user }}"
    shell: "{{ deployer_shell }}"
    groups: "{{ deployer_groups }}"
    append: true
    create_home: true
    home: "{{ deployer_home }}"
    state: present

- name: Allow deployer limited sudo commands (no password)
  template:
    src: deployer-sudoers.j2
    dest: "/etc/sudoers.d/{{ deployer_user }}"
    owner: root
    group: root
    mode: "0440"
    validate: /usr/sbin/visudo -cf %s

- name: Add SSH authorized key for deployer
  authorized_key:
    user: "{{ deployer_user }}"
    key: "{{ lookup('file', role_path + '/files/' + ssh_root_pubkey_file) }}"
    state: present
